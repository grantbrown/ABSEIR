---
title: "Kikwit Ebola Analysis"
output: html_document
---
**Disclaimer: ** tutorial in progress.


1. Load library and data
```{r}
# load the ABSEIR library
library(ABSEIR)
# read in the data set
data(Kikwit1995)
```


2. Plot cases
```{r}
# make barplot of new case counts
barplot(t(Kikwit1995$Count), main = "New Cases", xlab = "Day", ylab = "Cases")
# add an X axis to give a reference epidemic time
axis(side = 1, at = seq(0, nrow(Kikwit1995), 50)) 
```

3. Build model

```{r}
# Create a model to relate observe data to epidemic process
data_model = DataModel(Kikwit1995$Count,
                       type = "identity",
                       compartment="I_star",
                       cumulative=FALSE)
# Create a model to describe relationship of any covariates to epidemic intensity
exposure_model_1 = ExposureModel(matrix(1, nrow = nrow(Kikwit1995)),
                                nTpt = nrow(Kikwit1995),
                                nLoc = 1,
                                betaPriorPrecision = 0.5,
                                betaPriorMean = 0)
# Create a (more realistic) Model to describe relationship of any covariates to epidemic intensity
# In this analysis we know on which date interventions began, so we may include a linear term
# starting on that date. 
intervention_term = cumsum(Kikwit1995$Date >  as.Date("05-09-1995", "%m-%d-%Y"))
intervention_term = intervention_term/max(intervention_term)
exposure_model_2 = ExposureModel(cbind(1,intervention_term),
                                nTpt = nrow(Kikwit1995),
                                nLoc = 1,
                                betaPriorPrecision = 0.5,
                                betaPriorMean = 0)
# There's no reinfection in this case, so we just use a "SEIR" model. 
reinfection_model = ReinfectionModel("SEIR")
# we have no distance model, because it's a non-spatial analysis, but we still
# need to create an empty DistanceModel for ABSEIR. This approach is a bit clunky, 
# so we're open to suggestions. One option may be the implmentation of new verisons
# of the qSEIR functions included in libSpatialSEIR. 
distance_model = DistanceModel(list(matrix(0)))

# Set initial population sizes
initial_value_container = InitialValueContainer(S0=5.36e6,
                                                E0=2,
                                                I0=2,
                                                R0=0)
  
  
# Model to describe the E to I and I to R transitions.  
# These can be constructed based on an exponential assumption (fast), 
# or by a more general path-specific model (less fast). 
# Here's an example of the exponential transition model, using
# Prior values from Lekone and Finkenstadt 2006:
exp_transition_priors = ExponentialTransitionPriors(p_ei = 1-exp(-1/5), 
                                     p_ir= 1-exp(-1/7),
                                     p_ei_ess = 100,
                                     p_ir_ess = 100)

# Now let's specify a path specific transition model, which allows
# us to incorporate arbitrary distributions for the latent
# and infectious periods:

latent.distribution = function(x)
{
  dweibull(x,2,8)
}
infectious.distribution = function(x)
{
  dweibull(x,5,12)
}
ps_transition_priors = PathSpecificTransitionPriors(Z1 = latent.distribution,
                                                    Z2 = infectious.distribution)

plot(latent.distribution, xlim = c(0, 30), main = "Assumed Distribution of Latent Period")
plot(infectious.distribution, xlim = c(0, 30), main = "Assumed Distribution of Infectious Period")

# Parameterized Weibull
#plot(function(x){dgamma(x, 50, 5)}, xlim = c(0,20))


wb_transition_priors = WeibullTransitionPriors(15,10,
                                               95,15,
                                               80,15,
                                               50,5)


# Set algorithm configuration
sampling_control = SamplingControl(seed = 123123, 
                                   n_cores = 14,
                                   algorithm="Beaumont2009",
                                    list(batch_size = 1000,
                                           epochs = 1e6,
                                           max_batches = 50,
                                           shrinkage = 0.99,
                                           multivariate_perturbation=TRUE
                                         )
                                   )


```

4. Run our three models

```{r}

# Underspecified intensity, exponential transition
runtime1 = system.time(result1 <- SpatialSEIRModel(data_model,
                          exposure_model_1,
                          reinfection_model,
                          distance_model,
                          exp_transition_priors,
                          initial_value_container,
                          sampling_control,
                          samples = 100,
                          verbose = FALSE))
# Reasonable intensity, exponential transition
runtime2 = system.time(result2 <- SpatialSEIRModel(data_model,
                          exposure_model_2,
                          reinfection_model,
                          distance_model,
                          exp_transition_priors,
                          initial_value_container,
                          sampling_control,
                          samples = 100,
                          verbose = FALSE))
# Reasonable intensity, path specific transition
runtime3 = system.time(result3 <- SpatialSEIRModel(data_model,
                          exposure_model_2,
                          reinfection_model,
                          distance_model,
                          ps_transition_priors,
                          initial_value_container,
                          sampling_control,
                          samples = 100,
                          verbose = FALSE))
# Reasonable intensity, parameterized path specific transition
runtime4 = system.time(result4 <- SpatialSEIRModel(data_model,
                          exposure_model_2,
                          reinfection_model,
                          distance_model,
                          wb_transition_priors,
                          initial_value_container,
                          sampling_control,
                          samples = 100,
                          verbose = FALSE))




timeMatrix = rbind(runtime1,runtime2,runtime3,runtime4)
rownames(timeMatrix) = paste("model", 1:4)
print(timeMatrix[,1:3])

```

5. Compare the two models, and consider a summary of their parameter estimates.

```{r}
compareModels(result1, result2, n_samples = 1000, 
              batch_size = 2000)
compareModels(result2, result3, n_samples = 1000, 
              batch_size = 2000)
compareModels(result2, result4, n_samples = 1000, 
              batch_size = 2000)

summary(result1)

summary(result2)

summary(result3)

summary(result4)

```

We observe strong evidence for model 2 over model 1, and very minor evidence for model 2 over model 3. It appears that, 
for these data (and these chosen path specific distributions), an intervention term is incredibly important, while the exponential assumption on transition times is not
particularly problematic. 

6. Consider model fit by looking at posterior predictive distribution of epidemic values. 

```{r}
# Simulate new epidemics based on the accepted parameters for model 1

simulations1 = epidemic.simulations(result1, replicates = 50)
simulations2 = epidemic.simulations(result2, replicates = 50)
simulations3 = epidemic.simulations(result3, replicates = 50)
simulations4 = epidemic.simulations(result4, replicates = 50)

plotPosteriorPredictive = function(simulations, main)
{
  allSimulatedI_star = sapply(simulations$simulationResults, function(x){x$I_star})
  
  lowerQuantile = apply(allSimulatedI_star, 1, quantile, probs = c(0.025))
  posteriorMean = apply(allSimulatedI_star, 1, mean)
  upperQuantile = apply(allSimulatedI_star, 1, quantile, probs = c(0.975))
  
  
  plot(Kikwit1995$Count, ylim = c(0, max(Kikwit1995$Count)*1.2),
       xlab = "Epidemic Day", ylab = "New Cases", main = main)
  lines(upperQuantile, lty = 2, col = "blue")
  lines(lowerQuantile, lty = 2, col = "blue")
  lines(posteriorMean, lty = 1, col = "blue")
  
  legend(x = 100, y = 12, legend = c("Mean", "95% CI", "Observed"), lty = c(1,2,0), 
         pch = c(NA,NA,1), col = c("blue", "blue", "black"), cex = 1)
}

plotPosteriorPredictive(simulations1, "Model 1: Posterior Predictive Distribution")
plotPosteriorPredictive(simulations2, "Model 2: Posterior Predictive Distribution")
plotPosteriorPredictive(simulations3, "Model 3: Posterior Predictive Distribution")
plotPosteriorPredictive(simulations4, "Model 4: Posterior Predictive Distribution")

```


7. Look at reproductive number estimates

```{r}

plotR0 = function(simulations, main)
{
  allSimulatedR0 = sapply(simulations$simulationResults, function(x){x$R0t})
  allSimulatedEA_R0 = sapply(simulations$simulationResults, function(x){x$R_EA})

  plot(apply(allSimulatedR0, 1, mean), type = "l", ylim = c(0, 3), lwd =2,
       ylab = "Reproductive Number", main = main)
  lines(apply(allSimulatedEA_R0, 1, mean), lwd = 2, lty = 2, col = "blue")
}
plotR0(simulations1, "Model 1: R0(t) and EA-R(t)")
plotR0(simulations2, "Model 2: R0(t) and EA-R(t)")
plotR0(simulations3, "Model 3: R0(t) and EA-R(t)")
plotR0(simulations4, "Model 4: R0(t) and EA-R(t)")

```
